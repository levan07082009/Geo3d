<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Upload Custom Model - Geo3D</title>
<style>
.contact-container { background-color: var(--surface-color); padding: 20px; margin-top: 50px; text-align: center; border-radius: var(--border-radius); box-shadow: var(--shadow); }
.contact-container p { margin: 5px 0; }
.contact-container a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
.contact-container a:hover { text-decoration: underline; }
:root {
  --primary-color: #3498db;
  --secondary-color: #2c3e50;
  --background-color: #ecf0f1;
  --surface-color: #ffffff;
  --text-color: #34495e;
  --border-radius: 8px;
  --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin:0; background-color: var(--background-color); color: var(--text-color);}
.container { width:90%; max-width:1200px; margin:0 auto; padding:20px 0;}
h2 { text-align:center; color: var(--secondary-color); margin-bottom:30px;}
header { background-color: var(--surface-color); padding:15px 5%; display:flex; justify-content:space-between; align-items:center; box-shadow: var(--shadow); position:sticky; top:0; z-index:1000;}
.logo { font-size:1.5em; font-weight:bold; color: var(--primary-color); text-decoration:none;}
nav a { text-decoration:none; color: var(--secondary-color); margin-left:20px; font-weight:500; transition: color 0.3s;}
nav a:hover { color: var(--primary-color);}
.cart-indicator { position:relative; cursor:pointer;}
.cart-count { position:absolute; top:-10px; right:-15px; background-color: var(--primary-color); color:white; border-radius:50%; padding:2px 6px; font-size:0.8em; font-weight:bold;}
.upload-layout { display:grid; grid-template-columns:1fr 1fr; gap:40px; margin-top:40px;}
@media(max-width:900px){.upload-layout{grid-template-columns:1fr;}}
#viewer-container { background-color:#e0e0e0; border-radius: var(--border-radius); height:300px; display:flex; align-items:center; justify-content:center; color:#999; font-size:1.2em; position:relative; overflow:hidden; box-shadow: var(--shadow);}
.form-container { background-color: var(--surface-color); padding:30px; border-radius: var(--border-radius); box-shadow: var(--shadow);}
.form-group { margin-bottom:20px;}
.form-group label { display:block; margin-bottom:8px; font-weight:600; color: var(--secondary-color);}
.form-group input[type="text"], .form-group input[type="email"], .form-group input[type="number"], .form-group input[type="file"], .form-group textarea, .form-group select { width:100%; padding:12px; border:1px solid #ddd; border-radius: var(--border-radius); box-sizing:border-box; font-size:1em;}
.form-group input[type="file"] { padding:8px;}
.form-group textarea { resize: vertical; min-height:80px;}
.submit-btn { background-color: var(--primary-color); color:white; border:none; padding:15px 30px; font-size:1.1em; font-weight:bold; border-radius:30px; cursor:pointer; transition: background-color 0.3s, transform 0.2s; width:100%;}
.submit-btn:hover { background-color:#2980b9; transform:scale(1.02);}
.color-buttons { display:flex; gap:10px; flex-wrap:wrap;}
.color-button { width:30px; height:30px; border-radius:50%; border:2px solid #ccc; cursor:pointer;}
.color-button.selected { border:3px solid var(--primary-color);}
#model-info { background:white; margin-top:15px; padding:15px; border-radius:var(--border-radius); box-shadow: var(--shadow); font-size:0.95em; line-height:1.5; display:none;}
.small-note { font-size: 0.85em; color: #666; margin-top:6px; }
.upload-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  margin-top: 40px;
}
@media(max-width:900px){.upload-layout{grid-template-columns:1fr;}}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
@media(max-width:700px){.form-row{grid-template-columns:1fr;}}
.form-group.full-width { width: 100%; }


</style>
</head>
<body>

  <header>
    <a href="https://geo3d.run.place/index.html" class="logo">
        <img src="logo.png" alt="Geo3D Logo" style="height:40px; vertical-align:middle;">
        Geo3D
    </a>
    <nav>
        <a href="about-us.html">·Éï·Éò·Éú ·Éï·Éê·É†·Éó ·É©·Éï·Éî·Éú?</a>
        <a href="cart.html" class="cart-indicator">üõí Cart<span class="cart-count">0</span></a>
    </nav>
</header>

<div class="container">
  <h2>Get a Quote for Your Custom Model</h2>
  <div class="upload-layout">
    <!-- Left side: Viewer + Model Info -->
    <div>
      <div id="viewer-container">
        <div id="viewer-placeholder">3D Preview will appear here</div>
      </div>
  
      <!-- Model Info Panel (below viewer) -->
      <div id="model-info">
        <strong>Model Information:</strong><br>
        Volume: <span id="model-volume" data-mm="-">-</span> <span id="model-unit">mm¬≥</span><br>
        Size X: <span id="size-x" data-mm="-">-</span> <span id="unit-x">mm</span><br>
        Size Y: <span id="size-y" data-mm="-">-</span> <span id="unit-y">mm</span><br>
        Size Z: <span id="size-z" data-mm="-">-</span> <span id="unit-z">mm</span>
        <div class="small-note">Shown in the model‚Äôs native units (preview is normalized for viewing).</div>
      </div>
    </div>
  
    <!-- Right side: Form -->
    <div class="form-container">
      <form id="upload-form">
        <!-- File upload (full width) -->
        <div class="form-group full-width">
          <label for="upload-file">3D Model File (.stl, .obj)</label>
          <input type="file" id="upload-file" name="attachment" accept=".stl,.obj" required>
        </div>
  
        <!-- Two-column form rows -->
        <div class="form-row">
          <div class="form-group">
            <label for="user-name">Name</label>
            <input type="text" id="user-name" name="user_name" placeholder="John Doe" required>
          </div>
          <div class="form-group">
            <label for="user-email">Email Address</label>
            <input type="email" id="user-email" name="user_email" placeholder="you@example.com" required>
          </div>
        </div>
  
        <div class="form-row">
          <div class="form-group">
            <label for="user-phone">Mobile Number</label>
            <input type="text" id="user-phone" name="user_phone" placeholder="+1234567890" required>
          </div>
          <div class="form-group">
            <label for="filament">Filament Type</label>
            <select id="filament" name="filament" required>
              <option value="PLA">PLA</option>
              <option value="ABS">ABS</option>
              <option value="PETG">PETG</option>
              <option value="TPU">TPU</option>
              <option value="Nylon">Nylon</option>
            </select>
          </div>
        </div>
  
        <div class="form-row">
          <div class="form-group">
            <label for="infill">Infill (%)</label>
            <input type="number" id="infill" name="infill" min="0" max="100" required>
          </div>
          <div class="form-group">
            <label for="scale">Scale (%)</label>
            <input type="number" id="scale" name="scale" min="1" value="100" required>
          </div>
        </div>
  
        <div class="form-row">
          <div class="form-group">
            <label for="walls">Wall Count</label>
            <input type="number" id="walls" name="walls" min="1" value="3" required>
          </div>
          <div class="form-group">
            <label for="layer-height">Layer Height (mm)</label>
            <input type="text" id="layer-height" name="layer_height" value="0.2" required>
          </div>
        </div>
  
        <!-- Material color (full width) -->
        <div class="form-group full-width">
          <label>Material Color</label>
          <div class="color-buttons" id="color-buttons">
            <div class="color-button" data-color="#3498db" style="background:#3498db"></div>
            <div class="color-button" data-color="#e74c3c" style="background:#e74c3c"></div>
            <div class="color-button" data-color="#2ecc71" style="background:#2ecc71"></div>
            <div class="color-button" data-color="#f1c40f" style="background:#f1c40f"></div>
            <div class="color-button" data-color="#ffffff" style="background:#ffffff"></div>
            <div class="color-button" data-color="#000000" style="background:#000000"></div>
          </div>
          <input type="hidden" id="color-picker" name="color" value="#3498db">
        </div>
  
        <!-- Notes (full width) -->
        <div class="form-group full-width">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" name="notes"></textarea>
        </div>
  
        <!-- Units (full width) -->
        <div class="form-group full-width">
          <label for="unit-select">Units for Model Info (optional)</label>
          <select id="unit-select">
            <option value="mm" selected>mm</option>
            <option value="cm">cm</option>
            <option value="in">inches</option>
          </select>
        </div>
  
        <!-- Submit button -->
        <button type="submit" class="submit-btn">Send for Review</button>
      </form>
    </div>

    
  </div>
</div>

<!-- 3D Viewer libraries -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
emailjs.init("cSr-vym581jsnY7ZW"); // your EmailJS public key

document.addEventListener('DOMContentLoaded', () => {
  const viewerContainer = document.getElementById('viewer-container');
  const placeholder = document.getElementById('viewer-placeholder');
  const fileInput = document.getElementById('upload-file');
  const colorInput = document.getElementById('color-picker');
  const colorButtons = document.querySelectorAll('.color-button');
  const modelInfoBox = document.getElementById('model-info');
  const unitSelect = document.getElementById('unit-select');

  let scene, camera, renderer, controls, model;

  function initViewer() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xe0e0e0);

    camera = new THREE.PerspectiveCamera(
      75,
      viewerContainer.clientWidth / viewerContainer.clientHeight,
      0.1,
      2000
    );
    camera.position.set(200, 200, 200);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
    viewerContainer.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(200, 200, 200);
    scene.add(dirLight);

    scene.add(new THREE.AxesHelper(100));
    scene.add(new THREE.GridHelper(200, 20));

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = viewerContainer.clientWidth / viewerContainer.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(viewerContainer.clientWidth, viewerContainer.clientHeight);
    });
  }

  function computeOriginalBoundingBox(object) {
    object.updateMatrixWorld(true);
    const box = new THREE.Box3();
    const v = new THREE.Vector3();
    object.traverse(node => {
      if (node.isMesh && node.geometry && node.geometry.attributes && node.geometry.attributes.position) {
        const pos = node.geometry.attributes.position;
        for (let i = 0; i < pos.count; i++) {
          v.fromBufferAttribute(pos, i).applyMatrix4(node.matrixWorld);
          box.expandByPoint(v);
        }
      }
    });
    return box;
  }

  function computeTotalVolume(object) {
    object.updateMatrixWorld(true);
    let total = 0;
    const a = new THREE.Vector3(), b = new THREE.Vector3(), c = new THREE.Vector3();
    object.traverse(node => {
      if (node.isMesh && node.geometry && node.geometry.attributes && node.geometry.attributes.position) {
        const geom = node.geometry.index ? node.geometry.toNonIndexed() : node.geometry;
        const arr = geom.attributes.position.array;
        const m = node.matrixWorld;
        for (let i = 0; i < arr.length; i += 9) {
          a.set(arr[i],   arr[i+1], arr[i+2]).applyMatrix4(m);
          b.set(arr[i+3], arr[i+4], arr[i+5]).applyMatrix4(m);
          c.set(arr[i+6], arr[i+7], arr[i+8]).applyMatrix4(m);
          total += a.dot(b.clone().cross(c)) / 6.0;
        }
      }
    });
    return Math.abs(total);
  }

  function updateUnits() {
    const unit = unitSelect.value;
    const factor = unit === 'mm' ? 1 : unit === 'cm' ? 0.1 : 0.0393701;
    const volFactor = factor ** 3;

    ['x','y','z'].forEach(axis => {
      const el = document.getElementById(`size-${axis}`);
      const mmValue = parseFloat(el.dataset.mm);
      el.textContent = (mmValue * factor).toFixed(2);
      document.getElementById(`unit-${axis}`).textContent = unit;
    });

    const volEl = document.getElementById('model-volume');
    const volMM = parseFloat(volEl.dataset.mm);
    volEl.textContent = (volMM * volFactor).toFixed(2);
    document.getElementById('model-unit').textContent = unit === 'mm' ? 'mm¬≥' : unit === 'cm' ? 'cm¬≥' : 'in¬≥';
  }

  unitSelect.addEventListener('change', updateUnits);

  function showModelInfo(object) {
    const box = computeOriginalBoundingBox(object);
    const size = box.getSize(new THREE.Vector3());
    const volume = computeTotalVolume(object);

    ['x','y','z'].forEach((axis, i) => {
      const el = document.getElementById(`size-${axis}`);
      const val = size[axis];
      el.dataset.mm = val;
      el.textContent = val.toFixed(2);
    });

    const volEl = document.getElementById('model-volume');
    volEl.dataset.mm = volume;
    volEl.textContent = volume.toFixed(2);

    modelInfoBox.style.display = 'block';
    updateUnits();
  }

  function fitModelToGrid(object) {
    const box = new THREE.Box3().setFromObject(object);
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);
    const scale = 80 / maxDim;
    object.scale.set(scale, scale, scale);

    const newBox = new THREE.Box3().setFromObject(object);
    const center = newBox.getCenter(new THREE.Vector3());
    const minY = newBox.min.y;

    object.position.x -= center.x;
    object.position.z -= center.z;
    object.position.y -= minY;
  }

  function loadModel(file) {
    if (model) scene.remove(model);
    const reader = new FileReader();
    const ext = file.name.split('.').pop().toLowerCase();

    reader.onload = (event) => {
      let object;
      if (ext === 'stl') {
        const loader = new THREE.STLLoader();
        const geometry = loader.parse(event.target.result);
        object = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ color: colorInput.value }));
      } else if (ext === 'obj') {
        const loader = new THREE.OBJLoader();
        object = loader.parse(event.target.result);
        object.traverse(child => {
          if (child.isMesh) child.material = new THREE.MeshStandardMaterial({ color: colorInput.value });
        });
      } else {
        alert('Unsupported file');
        return;
      }

      showModelInfo(object);
      fitModelToGrid(object);
      scene.add(object);
      model = object;
      placeholder.style.display = 'none';
    };

    if (ext === 'stl') reader.readAsArrayBuffer(file);
    else reader.readAsText(file);
  }

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) { if (!scene) initViewer(); loadModel(file); }
  });

  colorButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      colorButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      const color = btn.dataset.color;
      colorInput.value = color;
      if (model) model.traverse(c => { if (c.isMesh) c.material.color.set(color); });
    });
  });
  colorButtons[0].classList.add('selected');

  const form = document.getElementById('upload-form');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const file = fileInput.files[0];
    if (!file) { alert('Select a file'); return; }

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "geo3d_unsigned");

    try {
      const res = await fetch("https://api.cloudinary.com/v1_1/dvyyjjh2q/auto/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if (!data.secure_url) throw new Error(data.error?.message || "Upload failed");
      const fileUrl = data.secure_url;

      const templateParams = {
        user_name: document.getElementById('user-name').value,
        user_email: document.getElementById('user-email').value,
        user_phone: document.getElementById('user-phone').value,
        file_name: file.name,
        file_url: fileUrl,
        color: colorInput.value,
        filament: document.getElementById('filament').value,
        infill: document.getElementById('infill').value,
        scale: document.getElementById('scale').value,
        walls: document.getElementById('walls').value,
        layer_height: document.getElementById('layer-height').value,
        notes: document.getElementById('notes').value,
        volume: document.getElementById('model-volume').textContent,
        size_x: document.getElementById('size-x').textContent,
        size_y: document.getElementById('size-y').textContent,
        size_z: document.getElementById('size-z').textContent,
        unit: unitSelect.value
      };

      await emailjs.send('service_7hetpye','template_5m2vn88', templateParams);
      alert('Email sent!');
      location.reload();
      form.reset();
      ['model-volume','size-x','size-y','size-z'].forEach(id => document.getElementById(id).textContent = '-');
      modelInfoBox.style.display = 'none';
      placeholder.style.display='flex';
      if (model) { scene.remove(model); model = null; }
    } catch (err) {
      console.error(err);
      alert("Error: " + err.message);
    }
  });

});
</script>
</body>
<div class="contact-container">
    <p>Email: <a href="mailto:geo3d.ge.store@gmail.com">geo3d.ge.store@gmail.com</a></p>
    <p>Phone: <a href="tel:+1234567890">+1 234 567 890</a></p>
    <p>&copy; 2025 Geo3D. All rights reserved.</p>
</div>
</html>
